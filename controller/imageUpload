const { S3Client, PutObjectCommand } = require('@aws-sdk/client-s3');
const multer = require('multer');
const multerS3 = require('multer-s3');
const path = require('path');
const allowedExtensions = ['.png', '.jpg', '.jpeg', '.bmp', '.gif'];

// AWS S3 클라이언트 설정
const s3Client = new S3Client({
  region: process.env.AWS_S3_REGION,
  credentials: {
    accessKeyId: process.env.AWS_S3_ACCESS_KEY,
    secretAccessKey: process.env.AWS_S3_SECRET_KEY,
  },
});

async function uploadFileToS3(file) {
  const timestamp = Date.now();
  const filename = `uploads/survey-images/${timestamp}_${file.originalname}`;

  const params = {
    Bucket: process.env.AWS_BUCKET,
    Key: filename,
    Body: file.buffer,
    ACL: 'public-read-write',
    ContentType: file.mimetype,
  };

  try {
    const command = new PutObjectCommand(params);
    await s3Client.send(command);
    return `https://${process.env.AWS_BUCKET}.s3.${process.env.AWS_S3_REGION}.amazonaws.com/${filename}`;
  } catch (error) {
    console.error('Error uploading file to S3:', error);
    throw error;
  }
}

// multer-s3 설정
const uploadS3 = multer({
  storage: multerS3({
    s3: s3Client,
    bucket: process.env.AWS_BUCKET,
    acl: 'public-read-write',
    contentType: multerS3.AUTO_CONTENT_TYPE,
    key: function (req, file, cb) {
      const timestamp = Date.now();
      //const originalName = file.originalname;
      const filename = `/uploads/survey-images/${timestamp}_${file.originalname}`;

      cb(null, filename);
    },
  }),
  limits: { fileSize: 5 * 1024 * 1024 },
  fileFilter: function (req, file, cb) {
    if (
      allowedExtensions.includes(path.extname(file.originalname).toLowerCase())
    ) {
      cb(null, true);
    } else {
      cb(new Error('Invalid file type'), false);
    }
  },
}).fields([
  { name: 'mainImage', maxCount: 1 },
  { name: 'questionImages', maxCount: 10 },
]);

module.exports = { uploadS3, uploadFileToS3 };
